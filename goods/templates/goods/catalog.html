{% extends 'base.html'%}
{% load static %}
{% load goods_custom_tags %}

{% block extends_style %}
    <link rel="stylesheet" href="{% static 'bookcamp/css/pagination.css' %}">
    <link rel="stylesheet" href="{% static 'bookcamp/css/card.css' %}">
    <link rel="stylesheet" href="{% static 'bookcamp/css/card-catalog.css'%}">
{% endblock %}

{% block section %}
  <section class="content-catalog">
        <div class="catalog">
            <div class="row">
                {% get_avg_ranks products as avg_ranks%}
                {% if user.is_authenticated %}
                {% get_inventory_data products user.id as data_from_inventory %}
                {% endif %}
                {% for product in products %}
                <div id="id_{{product.slug}}" class="card">
                    <div>
                        <div class="card-img">
                            <a href="{% url 'goods:product' product.slug %}">
                                {% if product.image %}
                                    <img title="{{product.name}}"
                                            src="{{ product.image.url }}" alt="{{ product.name}}">
                                {% else %}
                                    <img title="{{product.name}}"
                                            src="{% static 'bookcamp/image/empty.jpg' %}" alt="{{ product.name}}">
                                {% endif %}
                            </a>
                        </div>
                        <div class="card-main">
                            <div>
                                <a class="card-title" title="{{product.name}}"
                                   href="{% url 'goods:product' product.slug %}">
                                    {% autoescape off %}
                                    {% if product.headline %}
                                        {{ product.headline|truncatewords:3 }}
                                    {% else %}
                                        {{ product.name|truncatewords:3 }}
                                    {% endif %}
                                    {% endautoescape %}
                                </a>
                                {% if user.is_authenticated %}
                                {%get_item data_from_inventory product.pk as product_status%}
                                    <div class="card-status {% if product_status is None %}invisible{% endif %}">
                                        <select {% if product_status is None %} disabled {% endif %}
                                                title="Выбрать статус"
                                                class="current_status" name="product_status" id="{{product.slug}}-status" >
                                            <option value="3" {% if product_status == 3 %} selected {% endif %}>Начато</option>
                                            <option value="2" {% if product_status == 2 %} selected {% endif %}>Отложенно</option>
                                            <option value="1" {% if product_status == 1 %} selected {% endif %}>Добавленно</option>
                                            <option value="0" {% if product_status == 0 %} selected {% endif %}>Прочитанно</option>
                                        </select>
                                    </div>
                                {% endif %}
                                <a class="card-author" href="?{% append_params authors=product.author.slug %}">Автор: {{ product.author }}</a>
                                <p>Дата выхода: {{ product.year_of_publication }}</p>
                                <p>
                                    {% autoescape off %}
                                    {% if product.bodyline %}
                                        {{ product.bodyline|truncatewords:20 }}
                                    {% else %}
                                        {{ product.description|truncatewords:10 }}
                                    {% endif %}
                                    {% endautoescape %}</p>
                            </div>
                            <div>
                                <p>
                                    Тэги:
                                </p>
                                <ul class="tag-list">
                                    {% for tag in product.get_tags %}
                                    <li class="tag"><a href="?{% append_params tags=tag.slug %}">{{ tag.name }}</a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-bottom margin-top {% if not user.is_authenticated %}display-card-not-authenticated{% endif %}">

                        {% get_item avg_ranks product.pk 0.00 as record %}
                        <div class="card-rank-catalog"
                             title="Рейтинг: {{record|floatformat:2}}">
                            {{ record|floatformat:2 }}
                        </div>
                        {% if user.is_authenticated %}
                            <button class="card-btn {% if product_status is not None %}remove{% endif %}"
                                    title="{% if product_status is not None %}Удалить из инвентаря
                                    {% else %}Добавить в инвентарь
                                    {% endif %}"
                                id="id_{{product.slug}}-{{product.pk}}"></button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% include 'includes/pagination.html' %}
        </div>
        <div class="filter">
            <form type="get" action="{% url 'goods:catalog' category_slug %}">
                <div class="container-search">
                    <input placeholder="..." name="q" type="text">
                    <button class="button" type="submit">Поиск</button>
                </div>
                <div>
                    <details open>
                        <summary class="inscription">
                            Теги:
                        </summary>
                        <div class="tags-filter filter-scroll">
                            {% get_all_tags as all_tags%}
                            {% for tag in all_tags%}
                            <div class="tag">
                                <input type="checkbox" {% if tag.slug in selected_tags %}checked{% endif %}
                                       value="{{ tag.slug }}" name="tags" id="id_{{ tag.slug }}">
                                <label for="id_{{ tag.slug }}">{{ tag.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    <details open class="filter-container">
                        <summary class="inscription">
                            Год издания:
                        </summary>
                        <label for="id_year_publication1">
                            от
                        </label>
                        <input id="id_year_publication1" name="year_from"
                               value="{% if year_from %}{{ year_from }}{% else %}2000{% endif %}" type="number">
                        <label for="id_year_publication2">
                            до
                        </label>
                        <input id="id_year_publication2" name="year_to"
                               value="{% if year_to %}{{ year_to }}{% else %}2025{% endif %}" type="number">
                    </details>
                    <details open="true" class="filter-container">
                        <summary class="inscription">
                            Сортировка:
                        </summary>
                        <div>
                            <input type="radio"  {% if ordering == 'author'%}checked{% endif %}
                                   value="author" name="ordering" id="id_ord_author">
                            <label for="id_ord_author">По автору</label>
                        </div>
                        <div>
                            <input type="radio" {% if ordering == 'year_of_publication'%}checked{% endif %}
                                   value="year_of_publication" name="ordering"  id="id_ord_date">
                            <label for="id_ord_date">По дате выхода</label>
                        </div>
                        <div>
                            <input type="radio" {% if ordering == 'name'%}checked{% endif %}
                                   value="name" name="ordering" id="id_ord_name">
                            <label for="id_ord_name">По названию книги</label>
                        </div>
                    </details>
                    <details open class="filter-container">
                        <summary class="inscription">
                            Авторы:
                        </summary>
                        {% get_authors category_slug as authors%}
                        <ul class="filter-scroll">
                            {% for author in authors %}
                            <li class="filter-list">
                                <input value="{{author.slug}}" {% if author.slug in selected_authors %}checked{% endif %}
                                       type="checkbox" name="authors" id="id_{{author.slug}}">
                                <label for="id_{{author.slug}}">{{author.name}}</label>
                            </li>
                            {% endfor %}
                        </ul>

                    </details>
                    <button class="button" type="submit">Применить</button>
                    <button class="button" type="reset">Сбросить</button>
                </div>
            </form>
        </div>
    </section>
{% endblock %}
{% block footer %}
    <footer>
        <p>&copy;Bookcamp </p>
    </footer>
{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="{% static 'bookcamp/js/generic.js' %}"></script>
    <script type="text/javascript" src="{% static 'bookcamp/js/select-status.js' %}"></script>
    <script type="text/javascript" src="{% static 'bookcamp/js/script-btns.js'%}"></script>
{% endblock %}